name: Webhook Demo Pipeline - Fail at Steps 2 & 3

on:
  # âœ… Webhook trigger - triggered via GitHub API
  repository_dispatch:
    types: [run-pipeline]

  # Also allow manual trigger for testing
  workflow_dispatch:
    inputs:
      trigger_source:
        description: 'What triggered this pipeline?'
        required: false
        default: 'manual'

jobs:

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: âœ… PASS - Setup & Validate
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  job-1-setup:
    name: âœ… Job 1 - Setup & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Show Trigger Info
        run: |
          echo "=========================================="
          echo "  Pipeline triggered via WEBHOOK"
          echo "=========================================="
          echo "Event: ${{ github.event_name }}"
          echo "Triggered by: ${{ github.event.client_payload.source || inputs.trigger_source || 'webhook' }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Timestamp: $(date)"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Validate Environment
        run: |
          echo "âœ… Node version: $(node --version)"
          echo "âœ… NPM version: $(npm --version)"
          echo "âœ… Docker version: $(docker --version)"
          echo "âœ… OS: $(uname -a)"

      - name: Job 1 Summary
        run: |
          echo "âœ… Job 1 PASSED - Setup complete"
          echo "job1_status=passed" >> $GITHUB_ENV

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: âŒ FAIL - Unit Tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  job-2-unit-tests:
    name: âŒ Job 2 - Unit Tests (WILL FAIL)
    runs-on: ubuntu-latest
    needs: job-1-setup
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm install || echo "No package.json found, continuing..."

      - name: Run Unit Tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          echo "Testing authentication module..."
          echo "Testing database module..."
          echo "Testing API endpoints..."
          echo ""
          echo "Test Results:"
          echo "  âœ… auth.test.js - PASSED (3/3)"
          echo "  âœ… api.test.js  - PASSED (5/5)"
          echo "  âŒ db.test.js   - FAILED (1/4)"
          echo ""
          echo "FAIL - db.test.js"
          echo "  â— Database connection test"
          echo "    Expected: connected"
          echo "    Received: undefined"
          echo ""
          echo "  â— Query timeout test"
          echo "    Expected: 200ms"
          echo "    Received: 5000ms"
          echo ""
          # âŒ This exit code causes the job to FAIL
          exit 1

      # This step is skipped because previous step failed
      - name: Upload Test Results
        if: always()
        run: |
          echo "âš ï¸ Tests failed - uploading failure report"
          echo "FAILED" > test-results.txt
          echo "Timestamp: $(date)" >> test-results.txt

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: âŒ FAIL - Integration Tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  job-3-integration-tests:
    name: âŒ Job 3 - Integration Tests (WILL FAIL)
    runs-on: ubuntu-latest
    needs: job-1-setup  # Depends on Job 1 only, runs parallel to Job 2
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Start Test Services
        run: |
          echo "ğŸš€ Starting test services..."
          echo "  â†’ Starting mock database..."
          echo "  â†’ Starting mock API server..."
          echo "  â†’ Waiting for services to be ready..."
          sleep 2
          echo "  âœ… Services started"

      - name: Run Integration Tests
        run: |
          echo "ğŸ”— Running integration tests..."
          echo ""
          echo "Testing: POST /api/users"
          echo "Testing: GET  /api/users/:id"
          echo "Testing: PUT  /api/users/:id"
          echo "Testing: DELETE /api/users/:id"
          echo ""
          echo "Integration Test Results:"
          echo "  âœ… POST /api/users     - 201 Created"
          echo "  âœ… GET  /api/users/:id - 200 OK"
          echo "  âŒ PUT  /api/users/:id - Expected 200, got 500"
          echo "  âŒ DELETE /api/users   - Expected 204, got 403 Forbidden"
          echo ""
          echo "INTEGRATION TEST FAILURE:"
          echo "  Error: Internal Server Error on PUT request"
          echo "  Error: Authorization header missing on DELETE"
          echo "  2 tests failed out of 4"
          echo ""
          # âŒ This exit code causes the job to FAIL
          exit 1

      - name: Cleanup Test Services
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up test services..."
          echo "  â†’ Stopping mock database"
          echo "  â†’ Stopping mock API server"
          echo "âœ… Cleanup complete"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4: â­ï¸ SKIPPED - Build (depends on failed jobs)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  job-4-build:
    name: â­ï¸ Job 4 - Build (Skipped due to failures)
    runs-on: ubuntu-latest
    needs: [job-2-unit-tests, job-3-integration-tests]
    if: success()  # Only runs if ALL previous jobs passed
    steps:
      - name: Build Application
        run: |
          echo "ğŸ³ Building Docker image..."
          docker build -t app:latest .
          echo "âœ… Build complete"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 5: ğŸ“Š ALWAYS RUNS - Pipeline Summary
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pipeline-summary:
    name: ğŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [job-1-setup, job-2-unit-tests, job-3-integration-tests]
    if: always()  # Always runs regardless of failures
    steps:
      - name: Print Pipeline Summary
        run: |
          echo "=========================================="
          echo "          PIPELINE SUMMARY REPORT"
          echo "=========================================="
          echo ""
          echo "Trigger:    Webhook (repository_dispatch)"
          echo "Run ID:     ${{ github.run_id }}"
          echo "Branch:     ${{ github.ref_name }}"
          echo "Commit:     ${{ github.sha }}"
          echo "Timestamp:  $(date)"
          echo ""
          echo "Job Results:"
          echo "  Job 1 - Setup:              ${{ needs.job-1-setup.result }}"
          echo "  Job 2 - Unit Tests:         ${{ needs.job-2-unit-tests.result }}"
          echo "  Job 3 - Integration Tests:  ${{ needs.job-3-integration-tests.result }}"
          echo "  Job 4 - Build:              SKIPPED (upstream failures)"
          echo ""
          echo "=========================================="
          echo " âœ… Job 1: PASSED"
          echo " âŒ Job 2: FAILED  â† Unit test failures"
          echo " âŒ Job 3: FAILED  â† Integration test failures"
          echo " â­ï¸  Job 4: SKIPPED â† Depends on failed jobs"
          echo "=========================================="
          echo ""
          echo "Action Required: Fix failing tests before next run"
